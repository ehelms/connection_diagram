@startuml

[Browser] as browser

node "server" {
  [Postgres] as postgres
  [Candlepin] as candlepin

  [MongoDB] as mongo_server
  [Qpid] as qpidd_server
  [Dispatch Router] as qdrouterd_server
  [Smart Proxy] as smart_proxy_server
  [Dynflow] as dynflow_server

  [Puppet Server] as puppet_server

  [Pulp Resource Manager] as pulp_resource_manager_server
  [Pulp Celerybeat] as pulp_celerybeat_server
  [Pulp Worker] as pulp_worker_server
  [Squid] as squid

  node "Apache" as server_apache {

    node "Foreman Application" {
      [Foreman] as foreman
      [Katello] as katello
      [Foreman Tasks] as foreman_tasks
      [Foreman Docker] as foreman_docker
      [Foreman Discovery] as foreman_discovery
      [Foreman SCAP] as foreman_scap

      katello ..> foreman
      katello ..> foreman_tasks
      katello ..> foreman_docker

      foreman_discovery ..> foreman
      foreman_docker ..> foreman
      foreman_scap ..> foreman
      foreman_tasks ..> foreman
    }

    node "Pulp" as pulp_server {
      [API] as pulp_api_server
      [Streamer] as pulp_streamer_server
      [Repo Auth] as repo_auth_server
    }

    [Crane] as crane_server

  }

  foreman -[#red]down-> postgres : localhost
  dynflow_server -[#red]-> postgres : localhost

  katello -[#cyan]down-> candlepin : localhost:8443
  katello -[#cyan]-> pulp_api_server : hostname:443
  katello -[#orange]> qpidd_server : localhost:5671

  qdrouterd_server -[#green]-> qpidd_server : localhost:5671

  pulp_api_server -[#red]-> mongo_server : localhost:27017
  pulp_api_server -[#green]-> qpidd_server : localhost:5671

  pulp_worker_server -[#red]-> mongo_server : localhost:27017
  pulp_worker_server -[#green]-> qpidd_server : localhost:5671
  pulp_celerybeat_server -[#green]-> qpidd_server : localhost:5671
  pulp_resource_manager_server -[#green]-> qpidd_server : localhost:5671
  pulp_streamer -[#red]-> mongo_server : localhost:27017
  pulp_streamer -[#red]-> squid

  candlepin -[#red]down-> postgres: localhost
  candlepin -[#orange]-> qpidd_server : localhost:5671

  foreman -[#green]-> smart_proxy_server : hostname:9090
  foreman -[#green]-> smart_proxy_foreman_proxy : hostname:9090
  smart_proxy_server -[#green]-> foreman : hostname:443
}

node "Foreman Proxy" {
  [Smart Proxy] as smart_proxy

  [Qpid] as qpidd_foreman_proxy
  [MongoDB] as mongo_foreman_proxy
  [Dispatch Router] as qdrouterd_foreman_proxy

  [Puppet Server] as puppet_server_foreman_proxy

  node "Apache" as apache_foreman_proxy {

    node "Pulp" as pulp_foreman_proxy {
      [API] as pulp_api_foreman_proxy
    }

    [Crane] as crane_server
  }

  smart_proxy -[#green]-> foreman : 443

  pulp_api_foreman_proxy -[#red]-> mongo_foreman_proxy : localhost:27017
  pulp_api_foreman_proxy -[#green]-> qpidd_foreman_proxy : hostname:5671

  qdrouterd_foreman_proxy -[#green]-> qdrouterd_server : hostname:5646

  pulp_api_foreman_proxy -[#red]-> mongo_foreman_proxy : localhost:27017
  pulp_api_foreman_proxy -[#green]-> qpidd_foreman_proxy : localhost:5671
  pulp_api_foreman_proxy -[#green]-> apache_server : hostname:5671

  pulp_worker_foreman_proxy -[#red]-> mongo_foreman_proxy : localhost:27017
  pulp_worker_foreman_proxy -[#green]-> qpidd_foreman_proxy : localhost:5671
  pulp_celerybeat_foreman_proxy -[#green]-> qpidd_foreman_proxy : localhost:5671
  pulp_resource_manager_foreman_proxy -[#green]-> qpidd_foreman_proxy : localhost:5671

}

node "Client" {
  [Yum] as yum
  [RHSM] as rhsm
  [Katello Agent] as katello_agent
  [Puppet] as puppet

  puppet -[#green]-> puppet_server : 443
}

node "Isolated Client" {
  [Isolated Yum] as isolated_yum
  [Isolated RHSM] as isolated_rhsm
  [Isolated Katello Agent] as isolated_katello_agent
  [Isolated Puppet] as isolated_puppet
}

smart_proxy_apache -[#green]-> server_apache : 443

isolated_rhsm -[#green]-> smart_proxy_apache : 8443
isolated_yum -[#green]-> smart_proxy_apache : 443
isolated_yum -[#red]-> smart_proxy_apache : 80
isolated_katello_agent -[#green]-> qdrouterd_foreman_proxy : 5647
isolated_puppet -[#green]-> smart_proxy_puppet_server : 443

browser -[#red]-> server_apache : 80
browser -[#orange]-> foreman : 443
rhsm -[#green]-> katello : 443
yum  -[#green]-> server_apache : 443
yum -[#red]-> server_apache : 80
katello_agent -[#green]-> qdrouterd_server : 5647

foreman -[#green]-> smart_proxy_apache : 9090

isolated_puppet -[#green]-> smart_proxy_puppet_server : 8140

legend right
  (Green) -> SSL two-way
  (Orange) -> SSL one-way
  (Cyan) -> SSL no cert validation
  (Red) -> no SSL
endlegend

@enduml

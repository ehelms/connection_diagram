@startuml

[Browser] as browser

node "server" {
  [Postgres] as postgres
  [Candlepin] as candlepin

  [Elasticsearch] as elasticsearch
  [MongoDB] as mongo_server
  [Qpid] as qpidd_server
  [Dispatch Router] as qdrouterd_server
  [Smart Proxy] as server_smart_proxy

  node "Apache" as server_apache {

    node "Pulp" as pulp_server {
      [API] as pulp_server_api
      [pulp_* processes] as pulp_server_backend
    }

    [Puppet Master] as puppet_master

    node "Foreman Application" {
      [Foreman] as foreman
      [Katello] as katello
      [Foreman Tasks] as foreman_tasks
      [Dynflow] as dynflow
      [Foreman Docker] as foreman_docker
      [Foreman Discovery] as foreman_discovery
      [Foreman SCAP] as foreman_scap

      foreman_tasks -down..> dynflow
      katello ..> foreman
      katello ..> foreman_tasks
      katello ..> foreman_docker

      foreman_discovery ..> foreman
      foreman_docker ..> foreman
      foreman_scap ..> foreman
      foreman_tasks ..> foreman

      dynflow ..> postgres
    }

  }

  foreman -[#red]down-> postgres : localhost
  candlepin -[#red]down-> postgres: localhost

  katello -[#cyan]down-> candlepin : localhost:8443
  katello -[#cyan]-> pulp_server_api : hostname:443
  katello -[#red]down-> elasticsearch : localhost:9200
  katello -[#orange]> qpidd_server : hostname:5671

  qdrouterd_server -[#green]-> qpidd_server : localhost:5671

  pulp_server_api -[#red]-> mongo_server : localhost:27017
  pulp_server_api -[#green]-> qpidd_server : hostname:5671

  pulp_server_backend -[#red]-> mongo_server : localhost:27017
  pulp_server_backend -[#green]-> qpidd_server : hostname:5671

  candlepin -[#orange]-> qpidd_server : hostname:5671

  foreman -[#green]-> server_smart_proxy
}

node "Capsule" {
  [Smart Proxy] as smart_proxy

  [Qpid] as qpidd_capsule
  [MongoDB] as mongo_capsule
  [Dispatch Router] as qdrouterd_capsule

  node "Apache (Smart Proxy)" as smart_proxy_apache {
  
    [Puppet Master] as smart_proxy_puppet_master

    node "Pulp" as pulp_capsule {
      [API] as pulp_capsule_api
      [pulp_* process] as pulp_capsule_backend
    }
  }

  smart_proxy -[#green]-> foreman : 443

  pulp_capsule_api -[#red]-> mongo_capsule : localhost:27017
  pulp_capsule_api -[#green]-> qpidd_capsule : hostname:5671

  pulp_capsule_backend -[#red]-> mongo_capsule : localhost:27017
  pulp_capsule_backend -[#green]-> qpidd_capsule : hostname:5671
}

node "Client" {
  [Yum] as yum
  [RHSM] as rhsm
  [Katello Agent] as katello_agent
  [Puppet] as puppet
}

node "Isolated Client" {
  [Isolated Yum] as isolated_yum
  [Isolated RHSM] as isolated_rhsm
  [Isolated Katello Agent] as isolated_katello_agent
  [Isolated Puppet] as isolated_puppet
}

smart_proxy_apache -[#green]-> server_apache : 443

isolated_rhsm -[#green]-> smart_proxy_apache : 8443
isolated_yum -[#green]-> smart_proxy_apache : 443
isolated_yum -[#red]-> smart_proxy_apache : 80
isolated_katello_agent -[#green]-> qdrouterd_capsule : 5647
isolated_puppet -[#green]-> smart_proxy_puppet_master : 443

browser -[#red]-> server_apache : 80
browser -[#orange]-> foreman : 443
rhsm -[#green]-> katello : 443
yum  -[#green]-> server_apache : 443
yum -[#red]-> server_apache : 80
katello_agent -[#green]-> qdrouterd_server : 5647

qdrouterd_capsule -[#green]-> qdrouterd_server : hostname:5646

foreman -[#green]-> smart_proxy_apache : 9090

puppet -[#green]-> puppet_master : 443
isolated_puppet -[#green]-> smart_proxy_puppet_master : 8140

legend right
  (Green) -> SSL two-way
  (Orange) -> SSL one-way
  (Cyan) -> SSL no cert validation
  (Red) -> no SSL
endlegend

@enduml
